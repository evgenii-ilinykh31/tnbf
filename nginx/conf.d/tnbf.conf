# Включаем базовые заголовки и ограничения
include /etc/nginx/conf.d/security.conf;

# -------- HTTP (порт 80) --------
# 1) Выдача ACME challenge для первичного выпуска сертификата (webroot)
# 2) Редирект всего остального на HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name tnbf.art www.tnbf.art;   # ← ПРОВЕРЬ ДОМЕНЫ (строка 11)

    # Точка для webroot валидации Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Редирект остального на HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# -------- HTTPS (порт 443) --------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name tnbf.art www.tnbf.art;   # ← ПРОВЕРЬ ДОМЕНЫ (строка 30)

    # Пути к сертификатам Let's Encrypt
    ssl_certificate     /etc/letsencrypt/live/tnbf.art/fullchain.pem; # ← ДОМЕН (строка 34)
    ssl_certificate_key /etc/letsencrypt/live/tnbf.art/privkey.pem;    # ← ДОМЕН (строка 35)

    # OCSP Stapling — ускоряет/защищает проверку валидности сертификата
    ssl_stapling on;
    ssl_stapling_verify on;
    # Для верификации цепочки укажем доверенный сертификат (обычно chain.pem)
    ssl_trusted_certificate /etc/letsencrypt/live/tnbf.art/chain.pem;  # ← ДОМЕН (строка 41)
    # DNS-резолверы для OCSP
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    # Опционально: кэш TLS-сессий
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Проксирование в Node/Next (сервис "app")
    location / {
        proxy_pass         http://app:3000;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto https;
        proxy_read_timeout 300;
    }

    # На всякий случай отдаём ACME challenge и по HTTPS
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }
}
